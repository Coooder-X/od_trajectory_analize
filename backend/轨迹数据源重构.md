## 轨迹数据源重构

#### 数据结构

重构后，轨迹和 OD 对的数据结构和原先一致：

```python
# OD 点数据结构
[[lon, lat, time, trj_id, flag], [], ...] trj_id 是轨迹id，flag==0 表示 O 点，1表示 D 点
# 轨迹数据结构：
[[index], [date], [lon1, lat1, time1], ..., [lon, lat, time]]
```

数据库：`trajectory_db`，

轨迹数据表：`trj_table`，

OD 数据表：`od_table` （暂时没用到）

```sql
CREATE TABLE trj_table (
    id INT AUTO_INCREMENT PRIMARY KEY,
    month INT,
    date INT,
    start_time INT DEFAULT NULL,
    end_time INT DEFAULT NULL,
    point_list JSON DEFAULT NULL
);
```

#### app.py 内重构内容：

- `get_od_filter_by_day_and_hour` 的逻辑改为 `query_od_by_trj_day_and_hour`，从数据库查询。

- 在计算**单日**轨迹数量时，将调用 `od_pair_process.get_trj_num_filter_by_day`  改为调用 `query_trj_num_by_day`

- 在计算**小时级别**轨迹数量时，将 `get_trj_num_filter_by_day_and_hour` 内的逻辑进行修改，改为调用  `query_trj_by_day_and_hour`
- 在函数 `trj_num_by_hour` 内，计算每小时轨迹数量的函数 `get_trj_num_filter_by_day` 改为调用 `query_trips_by_day`



## 目前的数据源与文件解释：

- **创建临时数据目录**：在当前项目（`od_trajectory_analize`）的同级目录下，创建一个 `/tmp` 目录，作为临时数据目录，存放一些描述**轨迹**的 `.pkl`、`.txt` 格式的数据。



- `od_trajectory_analize/backend/data`目录下，有用的文件如下：

  ```
  全天OD点经纬度(带轨迹id).pkl
  POI映射关系.pkl
  hangzhou-vocab-dist-cell250.h5
  hangzhou-vocab-dist-cell500.h5
  region.pkl
  ```

  其中 `readme.txt` 中描述了这些文件的生成过程，内容如下：

  > 这里生成的region.pkl等文件，都由 deepcluster 项目的 v1.1 中，preprocessing.py生成，其中注意 cellsize 500，usegrid 1，needtime 0，并且范围是整个杭州的范围。此前是在本项目中直接读取 deepcluster 的目录，并不规范，在此改成通过当前目录读取。若 region 需要更新，则从 deepcluster 重新生成，再复制过来。

  该目录中 `hangzhou-vocab-dist-cell` 文件的数字后缀表示**轨迹网格**的 `cell-size`，可自行配置并在代码的读取轨迹文件语句中修改文件名。若修改了 `cell-size`，则需要重新生成轨迹数据（即 `tmp` 目录下的所有 `pkl` 文件、重新初始化数据库中所有轨迹数据）

- `od_trajectory_analize/backend`目录下：

  - **read_trjs_1_2_8_10.pkl**：在程序运行过后会出现类似 `read_trjs_1_2_8_10.pkl` 的文件，可以不用管，是为了避免每次都要进行繁琐的查询和处理带来的时间开销，将处理后的中间数据缓存在此。
  - **od_flow_dict.pkl**：可以不用管，自动生成的缓存文件。
  - **best_model_4.pt**：轨迹特征提取所需的模型。
  - **expxxxx.txt**：exp 开头的 `txt` 文件，是 exp 开头的 `.py` 文件执行实验后输出的实验结果。

- `/od_trajectory_analize/backend/gcc/graph_convolutional_clustering/data/` 目录下，`gcc_W.pkl`、`gcc_G.pkl` 是 gcc 社区发现算法的模型，`.mat` 是数据集，可不用管。

## 数据库配置

数据库配置有一定时间成本，若要快速使用项目，在 `global_param.py` 中将 `use_database` 设置为 False 也可运行。

下载 `mysql-server_8.0.20-2ubuntu20.04_amd64.deb-bundle.tar` ，创建并解压到 `mysql` 目录，然后安装：

```shell
# 安装mysql
bin/mysqld \
--defaults-file=/home/zhengxuan.lin/project/mysql/my.cnf \
--initialize \
--user=zhengxuan.lin \
--basedir=/home/zhengxuan.lin/project/mysql \
--datadir=/home/zhengxuan.lin/project/mysql/data

```



```shell
# 启动mysql
bin/mysqld_safe --defaults-file=/home/zhengxuan.lin/project/mysql/my.cnf --user=zhengxuan.lin &
# 关闭mysql
bin/mysqladmin -u root -p -S /home/zhengxuan.lin/project/oper/mysql/mysql.sock shutdown
# 获取数据库的root用户密码
cat error.log | grep root@localhost
>>输出： 
2024-03-07T08:51:08.274295Z 6 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: Le-g:Ld!30+w
# 即密码为：Le-g:Ld!30+w
```



```shell
bin/mysql -u root -p -S /home/zhengxuan.lin/project/mysql/mysql.sock

# 登录成功之后，进行初始密码的修改
ALTER USER 'root'@'localhost' IDENTIFIED BY 'root';
# 使用户root能被任何host访问
update mysql.user set host = '%' where user = 'root';
# 刷新系统权限
flush privileges;
```



```shell
# 首先为用户创建一个数据库(test)
create database test


# 授权用户root(密码root)拥有test数据库的所有权限（host='%'表示该用户能被任何host访问）
grant all privileges on test.* to 'root'@'%' identified by 'root';
# 刷新系统权限后，修改才能生效
flush privileges;
```



## Bugs

- 数据视图-全局信息的获取极慢
- 网格划分极慢
- 线图生成速度极慢



## TODOS

- [x] app.py 数据库逻辑开关（报错：File "/home/zhengxuan.lin/project/od_trajectory_analize/backend/data_process/od_pair_process.py", line 168, in trips_filter_by_hour

  if start_hour * 3600 <= trips[i][2][2] <= end_hour * 3600:

- [x] exp.py 数据库重构、逻辑开关

- [x] 内存计算

- [ ] 显存计算

- [x] 数据库名、表名，提取到 global_param.py 中

- [x] 硬编码的路径，提取到 global_param.py 中

- [ ] v_env备份

- [ ] 简易使用的封装

- [ ] 出一个使用文档

- [X] 数据库配置